name: Build

env:
  WIX_VERSION: '6.0.2'

on:
  push:
    branches:
      - '**'  # All branches
    tags:
      - '*'  # All tags
  pull_request:
    branches:
      - '**'  # All branches

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x'

    - name: Build
      run: cmd /c build.bat
      shell: cmd

    - name: Test
      run: make test
      shell: bash

  installer:
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Fetch all history for git describe

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x'

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.x'

    - name: Install WiX Toolset
      run: |
        dotnet tool install --global wix --version ${{ env.WIX_VERSION }}
        wix extension add WixToolset.UI.wixext/${{ env.WIX_VERSION }} WixToolset.NetFx.wixext/${{ env.WIX_VERSION }} --global
      shell: pwsh

    - name: Build installer
      run: make installer
      shell: bash

    - name: Upload MSI artifact
      uses: actions/upload-artifact@v6
      with:
        name: NefMotoECUFlasher-installer
        path: Installer/bin/Release/NefMotoECUFlasher-*.msi
        retention-days: 90
