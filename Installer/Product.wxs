<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:netfx="http://wixtoolset.org/schemas/v4/wxs/netfx"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <?define ProductName="NefMotoECUFlasher"?>
  <?define FullVersion=$(env.FULL_VERSION)?>
  <?define TargetDir=$(env.ECUFlasher_TargetDir)?>
  <?define MemoryLayouts_TargetDir=MemoryLayouts\?>
  <Package Id="NefMotoECUFlasher"
    Name="$(var.ProductName) $(var.FullVersion)"
    Language="1033"
    Version="!(bind.fileVersion.$(var.ProductName).exe)"
    Manufacturer="Nefmoto"
    UpgradeCode="2d104af1-44d2-4686-b3e0-a860cb092af1"
    Compressed="yes">
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="$(var.ProductName)" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="RuntimeDlls" />
      <ComponentGroupRef Id="MemoryLayouts" />
      <ComponentGroupRef Id="ApplicationShortcuts" />
      <ComponentGroupRef Id="DesktopShortcut" />
    </Feature>

    <Property Id="ARPINSTALLLOCATION" Value="INSTALLFOLDER" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="ProductVersionDisplay" Value="$(var.FullVersion)" />
    <Property Id="REINSTALLMODE" Value="amus" />
    <WixVariable Id="WixUILicenseRtf" Value="Installer\gpl-3.0.rtf" />
    <ui:WixUI Id="WixUI_InstallDir" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="0" />

    <!-- MajorUpgrade configuration: Handles upgrades and downgrades (must be in Package element) -->
    <MajorUpgrade
      AllowDowngrades="yes"
      Schedule="afterInstallInitialize" />

    <!-- Launch conditions: Check for .NET 8 -->
    <Property Id="DOTNET8STATUS" Secure="yes" />
    <Property Id="DOTNET8STATUS86" Secure="yes" />
    <netfx:DotNetCompatibilityCheckRef Id="Net8CheckX64" />
    <netfx:DotNetCompatibilityCheckRef Id="Net8CheckX86" />
    <!-- DotNetCompatibilityCheck sets DOTNET8STATUS and/or DOTNET8STATUS86 to 0 if the .NET 8.0 Runtime is installed -->
    <!-- Install fails and the Message is displayed if the condition is NOT met -->
    <Launch
      Condition="Installed OR DOTNET8STATUS=&quot;0&quot; OR DOTNET8STATUS86=&quot;0&quot;"
      Message="This application requires the .NET 8.0 Runtime. Please install it from https://dotnet.microsoft.com/download/dotnet/8.0" />
  </Package>

  <Fragment>
    <ComponentGroup Id="ApplicationShortcuts" Directory="ApplicationProgramsFolder">
      <Component Id="ApplicationProgramsFolder" Guid="a1b2c3d4-e5f6-7890-abcd-ef1234567890">
        <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\Nefmoto\$(var.ProductName)" Name="Installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <netfx:DotNetCompatibilityCheck
      Id="Net8CheckX64"
      Property="DOTNET8STATUS"
      RuntimeType="desktop"
      Version="8.0.0"
      Platform="x64"
      RollForward="latestMajor" />

    <netfx:DotNetCompatibilityCheck
      Id="Net8CheckX86"
      Property="DOTNET8STATUS86"
      RuntimeType="desktop"
      Version="8.0.0"
      Platform="x86"
      RollForward="latestMajor" />
  </Fragment>

  <Fragment>
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="$(var.ProductName)">
        <Directory Id="MemoryLayoutsFolder" Name="MemoryLayouts" />
        <Directory Id="RuntimesFolder" Name="runtimes">
          <Directory Id="WinFolder" Name="win">
            <Directory Id="LibFolder" Name="lib">
              <Directory Id="Net80Folder" Name="net8.0" />
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="$(var.ProductName)" />
    </StandardDirectory>
    <StandardDirectory Id="DesktopFolder" />
  </Fragment>

  <Fragment>
    <!-- Desktop shortcut component -->
    <ComponentGroup Id="DesktopShortcut" Directory="DesktopFolder">
      <Component Id="DesktopShortcutComponent" Guid="f1e2d3c4-b5a6-9780-cdef-123456789abc">
        <Shortcut Id="DesktopShortcut" Name="$(var.ProductName)" Target="[INSTALLFOLDER]$(var.ProductName).exe" WorkingDirectory="INSTALLFOLDER" Icon="AppIcon" />
        <RegistryValue Root="HKCU" Key="Software\Nefmoto\$(var.ProductName)" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Product components in the installation folder -->
  <Fragment>
    <Icon Id="AppIcon" SourceFile="$(var.TargetDir)$(var.ProductName).exe" />
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="$(var.ProductName).exe" Guid="d2e4f421-0c73-4562-9af9-4f10dd16f278">
        <File Id="$(var.ProductName).exe" Name="$(var.ProductName).exe" Source="$(var.TargetDir)$(var.ProductName).exe" KeyPath="yes">
          <Shortcut Id="StartMenuShortcut" Directory="ApplicationProgramsFolder" Name="$(var.ProductName)" WorkingDirectory="INSTALLFOLDER" Icon="AppIcon" />
        </File>
      </Component>
      <Component Id="$(var.ProductName).exe.config" Guid="5d029180-2042-4344-b43b-e5b0809e9887">
        <File Id="$(var.ProductName).exe.config" Name="$(var.ProductName).exe.config" Source="ECUFlasher\app.config" KeyPath="yes" />
      </Component>
      <Component Id="$(var.ProductName).dll" Guid="1a2b3c4d-5e6f-7890-abcd-ef1234567890">
        <File Id="$(var.ProductName).dll" Name="$(var.ProductName).dll" Source="$(var.TargetDir)$(var.ProductName).dll" KeyPath="yes" />
      </Component>
      <Component Id="$(var.ProductName).runtimeconfig.json" Guid="b3c4d5e6-f7a8-9012-bcde-f12345678901">
        <File Id="$(var.ProductName).runtimeconfig.json" Name="$(var.ProductName).runtimeconfig.json" Source="$(var.TargetDir)NefMotoECUFlasher.runtimeconfig.json" KeyPath="yes" />
      </Component>
      <Component Id="$(var.ProductName).deps.json" Guid="c4d5e6f7-a8b9-0123-cdef-123456789012">
        <File Id="$(var.ProductName).deps.json" Name="$(var.ProductName).deps.json" Source="$(var.TargetDir)NefMotoECUFlasher.deps.json" KeyPath="yes" />
      </Component>
      <Component Id="FTD2XX_NET.dll" Guid="21949804-55a9-4cf1-b856-ce5b72fd3f6d">
        <File Id="FTD2XX_NET.dll" Name="FTD2XX_NET.dll" Source="$(var.TargetDir)FTD2XX_NET.dll" KeyPath="yes" />
      </Component>
      <Component Id="Communication.dll" Guid="d4cf033c-6330-4e20-9130-f26ef46bbcc9">
        <File Id="Communication.dll" Name="Communication.dll" Source="$(var.TargetDir)Communication.dll" KeyPath="yes" />
      </Component>
      <Component Id="ECUShared.dll" Guid="1161e03f-3326-4297-b492-1d333630dbae">
        <File Id="ECUShared.dll" Name="ECUShared.dll" Source="$(var.TargetDir)ECUShared.dll" KeyPath="yes" />
      </Component>
      <Component Id="ApplicationShared.dll" Guid="d42fabc7-0a7b-48b2-8104-3b8f85d8d525">
        <File Id="ApplicationShared.dll" Name="ApplicationShared.dll" Source="$(var.TargetDir)ApplicationShared.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    <ComponentGroup Id="RuntimeDlls" Directory="Net80Folder">
      <Component Id="System.IO.Ports.dll.runtime" Guid="a7b8c9d0-e1f2-3456-7890-123456789abc">
        <File Id="System.IO.Ports.dll.runtime" Name="System.IO.Ports.dll" Source="$(var.TargetDir)runtimes/win/lib/net8.0/System.IO.Ports.dll" KeyPath="yes" />
      </Component>
      <Component Id="System.Management.dll.runtime" Guid="b8c9d0e1-f2a3-4567-8901-23456789abcd">
        <File Id="System.Management.dll.runtime" Name="System.Management.dll" Source="$(var.TargetDir)runtimes/win/lib/net8.0/System.Management.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    <ComponentGroup Id="MemoryLayouts" Directory="MemoryLayoutsFolder">
      <Component Id="MemoryLayoutFiles" Guid="68F489B1-19DD-4A65-9018-358BBCD9F342">
        <File Id="ME7_29F200.MemoryLayout.xml" Name="ME7 29F200.MemoryLayout.xml" Source="$(var.MemoryLayouts_TargetDir)ME7 29F200.MemoryLayout.xml" />
        <File Id="ME7_29F200BB.MemoryLayout.xml" Name="ME7 29F200BB.MemoryLayout.xml" Source="$(var.MemoryLayouts_TargetDir)ME7 29F200BB.MemoryLayout.xml" />
        <File Id="ME7_29F400.MemoryLayout.xml" Name="ME7 29F400.MemoryLayout.xml" Source="$(var.MemoryLayouts_TargetDir)ME7 29F400.MemoryLayout.xml" />
        <File Id="ME7_29F400BB.MemoryLayout.xml" Name="ME7 29F400BB.MemoryLayout.xml" Source="$(var.MemoryLayouts_TargetDir)ME7 29F400BB.MemoryLayout.xml" />
        <File Id="ME7_29F800.MemoryLayout.xml" Name="ME7 29F800.MemoryLayout.xml" Source="$(var.MemoryLayouts_TargetDir)ME7 29F800.MemoryLayout.xml" />
        <File Id="ME7_29F800BB.MemoryLayout.xml" Name="ME7 29F800BB.MemoryLayout.xml" Source="$(var.MemoryLayouts_TargetDir)ME7 29F800BB.MemoryLayout.xml" />
        <File Id="ME7_29F800BT.MemoryLayout.xml" Name="ME7 29F800BT.MemoryLayout.xml" Source="$(var.MemoryLayouts_TargetDir)ME7 29F800BT.MemoryLayout.xml" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
